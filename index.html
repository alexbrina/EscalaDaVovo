<!DOCTYPE html>
<html>
<head>
<meta http-equiv="PRAGMA" content="NO-CACHE" />
<meta http-equiv="EXPIRES" content="-1" />
<meta charset=utf-8 />
<script>
Model = function() {

    var agendas = [];

    var apresentarAcompanhante = function(escala) {
        return escala.acompanhantes[escala.acompanhante];
    };

    var apresentarDiaDaSemana = function(dia) {
        var res = '';
        var diaDaSemana = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
        res += diaDaSemana[dia.getDay()];
        return res;
    };

    var apresentarData = function(dia) {
        var res = '';
        res += " " + ("0" + dia.getDate()).slice(-2);
        res += "/" + ("0" + (dia.getMonth() + 1)).slice(-2);
        res += "/" + dia.getFullYear();
        return res;
    };

    var hoje = function() {
        var hoje = new Date();
        return new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    };

    var inicializarEscalas = function(escalas) {
        var res = {turnos:[]};
        
        var i = escalas.length;
        while (i--) {
            escalas[i].id = i;
            escalas[i].acompanhante = 0;
            escalas[i].inicio = new Date(escalas[i].inicio);
            if (res.turnos.indexOf(escalas[i].turno) < 0) res.turnos.push(escalas[i].turno);
            var j = escalas[i].diasDaSemana.length;
            escalas[i].folgar = [];
            while (j--) {
                escalas[i].folgar[j] = 0;
            }
        }
        
        return res;
    };

    var eDiaDeAcompanhar = function(escala, dia) {
        return escala.diasDaSemana.indexOf(dia.getDay() + 1) > -1;
    };

    var determinaEscalaDoDia = function(escalas, dia, turno) {
        var i = 0, elegiveis = [], eleita = -1;
        
        i = escalas.length;
        while (i--) {
            if (escalas[i].turno == turno 
            && escalas[i].inicio <= dia
            && eDiaDeAcompanhar(escalas[i], dia)) elegiveis.push(i);
        }

        i = elegiveis.length;
        while (i--) {
            if (escalas[elegiveis[i]].folgar[dia.getDay()] > 0) {
                escalas[elegiveis[i]].folgar[dia.getDay()]--;
                continue;
            }
            
            if (eleita == -1 || escalas[elegiveis[i]].prioridade < escalas[eleita].prioridade) eleita = elegiveis[i];

            if (escalas[eleita].alternancia > 0) {
                escalas[eleita].folgar[dia.getDay()] = escalas[eleita].alternancia;
            }
        }
        
        return eleita;
    };

    var proximoAcompanhante = function(escala) {
        escala.acompanhante++;
        if (escala.acompanhante == escala.acompanhantes.length) escala.acompanhante = 0;
    };

    var incluirAgenda = function(escala, dia) {
        agendas.push({
            acompanhante: apresentarAcompanhante(escala),
            diaDaSemana: apresentarDiaDaSemana(dia),
            data: apresentarData(dia),
            dia: dia.getDay(),
            escala: escala
        });
    };

    var proximoDia = function(dia) {
        var confere = new Date(dia.getFullYear(), dia.getMonth(), dia.getDate());
        dia.setDate(dia.getDate() + 1);
        if (confere.getDate() === dia.getDate()) {
            dia.setHours(dia.getHours() + 2);
        }
    };

    var processar = function(escalas) {
        var dia = hoje();
        var fim = hoje().setMonth(dia.getMonth() + 7);
        var meta = inicializarEscalas(escalas);
        while (dia < fim) {
            var j = meta.turnos.length;
            while (j--) {
                var turno = meta.turnos[j];
                var i = determinaEscalaDoDia(escalas, dia, turno);
                if (i > -1) {
                    incluirAgenda(escalas[i], dia);
                    proximoAcompanhante(escalas[i]);
                }
            }
            proximoDia(dia);
        };
    };

    return {

        processar: processar,

        agendas: function() {
            return agendas;
        }

    };
};

AbstractView = function() {

    var that = {};
    
    that.apresentar = function(model) {
        var agendas = model.agendas();
        var res = that.gerarHtml(agendas);
        document.write(res);
    };

    return that;
};

SplitView = function() {

    var that = AbstractView();
    
    that.gerarHtml = function(agendas) {
        var fdsFlag = true;
        var res = '';
        res += '<table style="font-family:helvetica;font-size:30pt" cellspacing="0" cellpadding="5">';
        for (var i=0; i<agendas.length; i++) {
            res += '<tr style="background:'+agendas[i].escala.cor+';"><td>' 
            + agendas[i].acompanhante + '</td><td>' 
            + agendas[i].diaDaSemana + '</td><td>' 
            + agendas[i].escala.turno + '</td><td>' 
            + agendas[i].data 
            + '</td></tr>';
            if (agendas[i].dia === 0) fdsFlag = !fdsFlag;
        }
        res += '</table>';
        return res;
    };
    
    return {

        apresentar: that.apresentar

    };
};

Controller = function(escalas) {
    var model = new Model();
    model.processar(escalas);
    var view = new SplitView();
    view.apresentar(model);
};

AjustesParaNavegadorAntigo = function() {
    if (!Array.prototype.indexOf) {
        Array.prototype.indexOf = function(obj, start) {
             for (var i = (start || 0), j = this.length; i < j; i++) {
                 if (this[i] === obj) { return i; }
             }
             return -1;
        };
    }

    if (!Array.prototype.push) {
        Array.prototype.push = function(arg) {
             this[this.length] = arg;
             return this.length;
        };
    }
};

/*
CENARIO DE ACOMPANHANTES
-------------------------
A ordem dos acompanhantes define a sequencia da escala partindo do inicio
*/

AjustesParaNavegadorAntigo();

new Controller([{
        diasDaSemana: [2,3,4,5], // segunda a quinta
        turno: 'Noite',
        alternancia: 0, // não alterna
        prioridade: 0, // prioridade relativa p/ solucionar coincidencia de 2+ escalas, menor valor é prioritario
        acompanhantes: ['Ricardo', 'Nilza', 'Mariana', 'Márcio'],
        inicio: '2015/12/07',
        cor: '#FF6FFF'
    },{
        diasDaSemana: [6,7,1], // Sexta, Sábado e Domingo
        turno: 'Noite',
        alternancia: 0,
        prioridade: 1, 
        acompanhantes: ['Alexandre', 'Cairo', 'Marcella', 'Diogo', 'Roberta'],
        inicio: '2015/12/06',
        cor: '#FF3F3F'
    },{
        diasDaSemana: [7],
        turno: 'Dia',
        alternancia: 0,
        prioridade: 1,
        acompanhantes: ['Ricardo', 'Nilza', 'Mariana', 'Márcio', 'Angela', 'Alexandre', 'Cairo', 'Marcella', 'Diogo', 'Roberta'],
        inicio: '2015/12/12',
        cor: '#FFFF3F'
    },{
        diasDaSemana: [7],
        turno: 'Dia',
        alternancia: 1,
        prioridade: 0,
        acompanhantes: ['Marcelo'],
        inicio: '2015/12/19',
        cor: '#3FFF3F'
    },{
        diasDaSemana: [6,7],
        turno: 'Noite',
        alternancia: 1,
        prioridade: 0,
        acompanhantes: ['Marcelo'],
        inicio: '2015/12/18',
        cor: '#3FFF3F'
    }]);

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2463584-5', 'auto');
  ga('send', 'pageview');
</script>
<title>Escala Da Vovó</title>
</head>
<body>
</body>
</html>
